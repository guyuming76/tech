<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
	<title></title>
	<meta name="generator" content="LibreOffice 7.1.3.2 (Linux)"/>
	<meta name="created" content="00:00:00"/>
	<meta name="changed" content="2021-05-17T10:10:34.270844612"/>
	<meta name="Originator" content="Microsoft Word 14"/>
	<meta name="ProgId" content="Word.Document"/>
	<script language="JavaScript">
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?2a61a1e3b7adb3fc3b0da490d066c45b";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();

</script>
	<style type="text/css">
		@page { size: 21cm 29.7cm; margin-left: 2cm; margin-right: 1cm; margin-top: 1cm; margin-bottom: 1cm }
		p { margin-bottom: 0.25cm; color: #000000; line-height: 115%; background: transparent }
		a:link { color: #000080; so-language: zxx; text-decoration: underline }
	</style>
</head>
<body lang="zh-CN" text="#000000" link="#000080" vlink="#800000" dir="ltr"><p class="msonormal">
&nbsp;</p>
<p class="msonormal"><font size="4" style="font-size: 14pt">上篇实战了用</font>&nbsp;<font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">Pudb
</font></font></span></font><font face="宋体"><font size="4" style="font-size: 14pt">调试分析了</font></font>&nbsp;<font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">emerge
</font></font></span></font><font size="4" style="font-size: 14pt">发现安装</font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">conflict
</font></font></span></font><font size="4" style="font-size: 14pt">的过程：</font><font face="Liberation Serif, serif"><span lang="en-US"><a href="http://guyuming76.gitee.io/personal/gentoo/emergeAnalysis2.html"><font color="#0000ff"><font face="Wingdings"><font size="4" style="font-size: 14pt"><u>http://guyuming76.gitee.io/personal/gentoo/emergeAnalysis2.html</u></font></font></font></a>&nbsp;<font face="Calibri"><font size="4" style="font-size: 14pt">,
</font></font></span></font><font size="4" style="font-size: 14pt">接下来我们看一下</font>&nbsp;<font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">emerge
</font></font></span></font><font size="4" style="font-size: 14pt">调用</font>&nbsp;<font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">ebuild.sh
</font></font></span></font><font size="4" style="font-size: 14pt">进行代码安装的过程：</font></p>
<p class="msonormal">&nbsp;</p>
<p class="msonormal"><font size="4" style="font-size: 14pt">先是通过</font>&nbsp;<font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">grep
-ir ebuild.sh /usr/lib/python3.8/site-packages/</font></font>&nbsp;</span></font><font size="4" style="font-size: 14pt">，
找些调试的突破口，具体过程略过</font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">,
</font></font></span></font><font size="4" style="font-size: 14pt">下图断点处可以看出，对于</font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">ebuild
</font></font></span></font><font size="4" style="font-size: 14pt">的每个阶段，</font>&nbsp;<font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">emerge
</font></font></span></font><font size="4" style="font-size: 14pt">会</font>&nbsp;<font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">fork
</font></font></span></font><font size="4" style="font-size: 14pt">出一个子进程，然后在子进程里（</font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">pid
== 0</font></font></span></font><font size="4" style="font-size: 14pt">）执行</font>&nbsp;<font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">ebuild.sh.
</font></font></span></font><font size="4" style="font-size: 14pt">光标停在</font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">Variable</font></font></span></font><font face="宋体"><font size="4" style="font-size: 14pt">窗口里面
</font></font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">mycommand
</font></font></span></font><font size="4" style="font-size: 14pt">变量上，按键</font>&nbsp;<font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">r
</font></font></span></font><font size="4" style="font-size: 14pt">即可显示变量值，按键</font>&nbsp;<font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">t
</font></font></span></font><font size="4" style="font-size: 14pt">显示变量类型，</font>&nbsp;<font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">F1
</font></font></span></font><font face="宋体"><font size="4" style="font-size: 14pt">或
</font></font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">/
</font></font></span></font><font face="宋体"><font size="4" style="font-size: 14pt">键可以弹出帮助。</font></font></p>
<p class="msonormal" align="left" style="margin-bottom: 0.42cm"><img src="emergeAnalysis3.files/emergeAnalysis3458.png" name="Image1" align="bottom" width="1542" height="868" border="0"/>
<font color="#000000"><span style="background: #ffffff">&nbsp;</span></font></p>
<p class="msonormal">&nbsp;</p>
<p class="msonormal">&nbsp;</p>
<p class="msonormal"><font size="4" style="font-size: 14pt">另外，在</font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">Stack</font></font></span></font><font face="宋体"><font size="4" style="font-size: 14pt">窗口，可以看见调用栈中出现很多
</font></font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">EventLoop,
Async</font></font></span></font><font face="宋体"><font size="4" style="font-size: 14pt">，</font></font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">Task
</font></font></span></font><font size="4" style="font-size: 14pt">之类的名称，我一开始很懵，后来网上搜并阅读了</font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">python</font></font></span></font><font face="宋体"><font size="4" style="font-size: 14pt">的</font></font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">Asyncio</font></font></span></font><font size="4" style="font-size: 14pt">，比如</font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">:</font></font>&nbsp;&nbsp;<a href="https://zhuanlan.zhihu.com/p/83627584"><font color="#0000ff"><font face="Wingdings"><font size="4" style="font-size: 14pt"><u>https://zhuanlan.zhihu.com/p/83627584</u></font></font></font></a>&nbsp;</span></font><font size="4" style="font-size: 14pt">，才稍有了解。我一开始想，为啥要这个协程，直接用操作系统线程不就完了吗</font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">?
</font></font></span></font><font size="4" style="font-size: 14pt">后来一想，大量的操作系统线程会增加操作系统调度的负担</font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">;
</font></font></span></font><font size="4" style="font-size: 14pt">并且协程里面的任务并不需要“公平调度”带来的分时间片反复任务切换。这让我想起了当年的</font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">Windows3.1,
</font></font></span></font><font face="宋体"><font size="4" style="font-size: 14pt">所谓的协作多任务，一个问题是如果某个任务死循环了，不主动执行系统调用交出</font></font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">CPU</font></font></span></font><font face="宋体"><font size="4" style="font-size: 14pt">，整个系统也就死了。但在这里，如果</font></font>&nbsp;<font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">emerge
</font></font></span></font><font size="4" style="font-size: 14pt">不</font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">fork
</font></font></span></font><font size="4" style="font-size: 14pt">出新的进程，而是直接在本进程内运行实际的包编译安装过程，最多死的也就是
</font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">emerge
</font></font></span></font><font face="宋体"><font size="4" style="font-size: 14pt">进程，操作系统本身不受影响。而这里的任务实际上是建立在</font></font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">Fork</font></font></span></font><font face="宋体"><font size="4" style="font-size: 14pt">出来的子进程上的，看似是混用了</font></font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">Asyncio</font></font></span></font><font face="宋体"><font size="4" style="font-size: 14pt">和操作系统进程调度，这样做有啥好处？这里父子进程之间的交互，我还不是很了解，在上图断点处按
</font></font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">s
</font></font></span></font><font size="4" style="font-size: 14pt">调试进</font>&nbsp;<font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">_exec
</font></font></span></font><font size="4" style="font-size: 14pt">可以看到涉及到</font>&nbsp;<font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">pipe
</font></font></span></font><font face="宋体"><font size="4" style="font-size: 14pt">的设置（</font></font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">_setup_pipes
</font></font></span></font><font size="4" style="font-size: 14pt">调用），而在
</font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">os.fork()
</font></font></span></font><font size="4" style="font-size: 14pt">调用前，也创建了</font>&nbsp;<font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">pipe
(os.pipe()</font></font></span></font><font size="4" style="font-size: 14pt">调用</font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">)</font></font></span></font><font size="4" style="font-size: 14pt">。</font></p>
<p class="msonormal">&nbsp;</p>
<p class="msonormal"><font size="4" style="font-size: 14pt">截图里面的</font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">Pudb</font></font></span></font><font face="宋体"><font size="4" style="font-size: 14pt">的</font></font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">Stack</font></font></span></font><font face="宋体"><font size="4" style="font-size: 14pt">窗口不知道为啥变小了，左右宽度可以通过
</font></font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">+
- </font></font></span></font><font face="宋体"><font size="4" style="font-size: 14pt">键调整，但上下高度我没找到调整方式，接下来看看能否从</font></font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">pudb
</font></font></span></font><font size="4" style="font-size: 14pt">的源码里找到答案。</font></p>
<p class="msonormal">&nbsp;</p>
<p class="msonormal"><font size="4" style="font-size: 14pt">再就是，可以在</font>&nbsp;<font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">emerge
</font></font></span></font><font face="宋体"><font size="4" style="font-size: 14pt">命令后面加
</font></font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">--debug
</font></font></span></font><font size="4" style="font-size: 14pt">参数，输出</font>&nbsp;<font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">ebuild.sh
</font></font></span></font><font size="4" style="font-size: 14pt">的执行步骤，但内容太多，看起来不方便，我想用</font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">bashdb</font></font></span></font><font face="宋体"><font size="4" style="font-size: 14pt">调试，在</font></font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">ebuild.sh
</font></font></span></font><font size="4" style="font-size: 14pt">运行</font>&nbsp;<font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">source
/usr/share/bashdb/bashdb-trace </font></font></span></font><font size="4" style="font-size: 14pt">本身并不出错，但是一运行</font><font face="Liberation Serif, serif"><span lang="en-US"><font face="Calibri"><font size="4" style="font-size: 14pt">_Dbg_debugger
</font></font></span></font><font size="4" style="font-size: 14pt">就出错了：</font><font face="Liberation Serif, serif"><span lang="en-US"><a href="https://forums.gentoo.org/viewtopic-p-8587980-highlight-.html#8587980"><font color="#0000ff"><font face="Wingdings"><font size="4" style="font-size: 14pt"><u>https://forums.gentoo.org/viewtopic-p-8587980-highlight-.html#8587980</u></font></font></font></a>&nbsp;</span></font></p>
</body>
</html>